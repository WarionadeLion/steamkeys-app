<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steam Keys</title>

  <style>
    :root{
      --radius: 16px;

      --text:#eaf2ff;
      --muted:#b6c6e6;
      --border: rgba(180, 210, 255, .22);
      --shadow: 0 14px 40px rgba(0,0,0,.40);

      --accent:#7dd3fc;     /* helles cyan */
      --accent2:#60a5fa;    /* blau */
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;

      background-image: url("/images/background.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;

      color: var(--text);
    }
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background: rgba(5, 10, 25, 0.65);
      z-index: -1;
    }

    .hidden { display: none; }

    h1, h2{
      color: var(--accent);
      text-shadow: 0 0 18px rgba(125, 211, 252, .35);
      margin: 0 0 10px;
    }
    .sub, .small{ color: var(--muted); }
    .small{ font-size: 12px; }

    .shell{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px;
    }

    .topbar{
      display:flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .stats{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 25, 50, .35);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .grid{
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 16px;
    }

@media (max-width: 1400px){
  .grid{
    grid-template-columns: repeat(4, 1fr);
  }
}

@media (max-width: 1100px){
  .grid{
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 800px){
  .grid{
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 520px){
  .grid{
    grid-template-columns: 1fr;
  }
}

    @keyframes fadeUp{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform:none; }
    }

    .card{
      background: rgba(15, 25, 50, .35);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      transition: transform .15s ease, border-color .15s ease, opacity .2s ease, box-shadow .2s ease;
      animation: fadeUp .25s ease;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(125, 211, 252, .35);
    }

    .img{
      width: 100%;
      height: 140px;
      object-fit: cover;
      background: rgba(180,210,255,.08);
    }

    .content{
      padding: 12px;
      display: grid;
      gap: 10px;
    }

    .title{
      font-weight: 800;
      font-size: 15px;
      color: var(--text);
    }

    input, textarea{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(10, 18, 40, .35);
      color: var(--text);
      outline: none;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    input::placeholder, textarea::placeholder{ color: rgba(182,198,230,.75); }
    input:focus, textarea:focus{
      border-color: rgba(125,211,252,.55);
      box-shadow: 0 0 0 3px rgba(125,211,252,.12);
    }

    .row { display: grid; gap: 8px; max-width: 520px; }

    button{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(125,211,252,.28);
      background: rgba(10, 18, 40, .45);
      color: var(--text);
      cursor:pointer;
      transition: background-color .15s ease, border-color .15s ease, transform .05s ease, color .15s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    button:hover{
      background: rgba(20, 35, 70, .55);
      border-color: rgba(125,211,252,.45);
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .btn-primary{
      background: rgba(96,165,250,.22);
      border-color: rgba(96,165,250,.55);
    }
    .btn-primary:hover{
      background: rgba(96,165,250,.30);
      border-color: rgba(125,211,252,.70);
    }

    /* Kopierbutton soll komplett gr√ºn werden */
    .btn-success{
      background-color: #22c55e !important;
      border-color: #16a34a !important;
      color: white !important;
    }

    .btn-danger{
      background: rgba(239,68,68,.16);
      border-color: rgba(239,68,68,.45);
    }
    .btn-danger:hover{
      background: rgba(239,68,68,.22);
      border-color: rgba(239,68,68,.65);
    }

    .keybox{
      padding: 12px;
      border-radius: 12px;
      border: 1px dashed rgba(180,210,255,.35);
      background: rgba(10, 18, 40, .35);
      word-break: break-all;
      color: var(--text);
      font-family: ui-monospace, Consolas, monospace;
      font-size: 13px;
      display:none;
    }

    .admin{
      margin-top: 18px;
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(15, 25, 50, .38);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    table{
      width:100%;
      border-collapse: collapse;
      background: rgba(10, 18, 40, .18);
      border-radius: 12px;
      overflow: hidden;
      min-width: 720px;
    }
    th, td{
      padding: 10px;
      border-bottom: 1px solid rgba(180,210,255,.12);
      vertical-align: top;
    }
    th{
      text-align:left;
      color: var(--text);
      background: rgba(10, 18, 40, .35);
      cursor: pointer;
      user-select: none;
    }
    tr:hover td{ background: rgba(10, 18, 40, .22); }

    /* Toasts */
    .toast-container{
      position: fixed;
      top: 20px;
      right: 20px;
      display: grid;
      gap: 10px;
      z-index: 9999;
    }
    .toast{
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(15,25,50,.75);
      border: 1px solid var(--border);
      color: var(--text);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      animation: toastIn .25s ease;
    }
    .toast.success{ border-color: #22c55e; }
    .toast.error{ border-color: #ef4444; }
    @keyframes toastIn{
      from{ opacity:0; transform: translateY(-10px); }
      to{ opacity:1; transform:none; }
    }

    /* Empty state */
    #emptyState{
      text-align:center;
      max-width: 520px;
      margin: 18px auto;
    }

    /* Skeleton cards */
    .skeleton{
      height: 260px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: linear-gradient(
        100deg,
        rgba(255,255,255,.08) 40%,
        rgba(255,255,255,.18) 50%,
        rgba(255,255,255,.08) 60%
      );
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    @keyframes shimmer{
      from{ background-position: 200% 0; }
      to{ background-position: -200% 0; }
    }
  </style>
</head>

<body>
  <div id="toasts" class="toast-container"></div>

  <div class="shell">
    <div class="topbar">
      <div>
        <h1>√úbriggebliebene Steam Keys</h1>
        <p class="small">Keys sind erst nach Klick sichtbar und k√∂nnen nur 1√ó geclaimt werden.</p>
      </div>

      <div class="stats">
        <div id="statsAvail" class="pill small">üéÆ Verf√ºgbar: ‚Ä¶</div>
        <div id="statsClaimed" class="pill small hidden">üîí Geclaimt: ‚Ä¶</div>
        <button id="shareBtn" class="btn-primary" type="button">üîó Seite teilen</button>
      </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="admin hidden">
      <h2>üéÆ Keine Keys verf√ºgbar</h2>
      <p class="small">Zurzeit sind alle Steam Keys vergriffen.<br>Schau sp√§ter wieder vorbei!</p>
    </div>

    <!-- Skeletons -->
    <div id="skeletons" class="grid">
      <div class="skeleton"></div>
      <div class="skeleton"></div>
      <div class="skeleton"></div>
    </div>

    <!-- Cards -->
    <div id="grid" class="grid"></div>

    <!-- Admin Login (sichtbar), Admin Area (versteckt bis Token ok) -->
    <div class="admin" id="adminLogin">
      <h2>Admin</h2>
      <div class="row">
        <input id="adminToken" placeholder="Admin Token" type="password" />
        <button id="unlockAdminBtn" class="btn-primary" type="button">Admin freischalten</button>
        <button id="logoutBtn" class="btn-danger hidden" type="button">Logout</button>
        <div id="unlockStatus" class="small"></div>
      </div>
    </div>

    <div id="adminArea" class="hidden">
      <div class="admin">
        <h2>Admin: Key hinzuf√ºgen</h2>
        <div class="row">
          <input id="title" placeholder="Spielname (z.B. Hollow Knight)" />
          <input id="imageUrl" placeholder="Bild-URL (z.B. https://.../cover.jpg)" />
          <button id="fetchCoverBtn" class="btn-primary" type="button">Cover automatisch holen</button>
          <div id="coverStatus" class="small"></div>

          <input id="steamKey" placeholder="Ein Steam Key (oder Bulk darunter)" />
          <textarea id="bulkKeys" rows="5" placeholder="Bulk Import: ein Steam Key pro Zeile"></textarea>

          <button id="addBtn" class="btn-primary" type="button">Hinzuf√ºgen</button>
          <div id="addStatus" class="small"></div>
        </div>
      </div>

      <div class="admin">
        <h2>Admin: √úbersicht (alle Keys)</h2>
        <button id="refreshAdminBtn" class="btn-primary" type="button">√úbersicht neu laden</button>
        <div id="adminStatus" class="small"></div>

        <div style="overflow:auto; margin-top:10px;">
          <table id="adminTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Spiel</th>
                <th>Claimed?</th>
                <th>ClaimedAt</th>
                <th>SteamKey</th>
                <th style="cursor:default;">Aktion</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  function toast(msg, type="success", timeout=2500){
    const c = document.getElementById("toasts");
    const t = document.createElement("div");
    t.className = `toast ${type}`;
    t.textContent = msg;
    c.appendChild(t);
    setTimeout(() => t.remove(), timeout);
  }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function smoothRemove(el){
    el.style.opacity = "0";
    el.style.transform = "translateY(10px)";
    setTimeout(() => el.remove(), 200);
  }

  // --- Public stats (available always; claimed only when admin unlocked)
  function setAvailCount(n){
    document.getElementById("statsAvail").textContent = `üéÆ Verf√ºgbar: ${n}`;
  }
  function setClaimedCount(n){
    const el = document.getElementById("statsClaimed");
    el.textContent = `üîí Geclaimt: ${n}`;
    el.classList.remove("hidden");
  }

  // --- Feature 1+2+3+4+6 in loadKeys()
  async function loadKeys() {
    const skeletons = document.getElementById("skeletons");
    const grid = document.getElementById("grid");
    const emptyState = document.getElementById("emptyState");

    // Skeletons an
    skeletons.style.display = "grid";
    grid.style.display = "none";
    emptyState.classList.add("hidden");

    const res = await fetch("/api/keys");
    const keys = await res.json();

    // Update available stats
    setAvailCount(keys.length);

    grid.innerHTML = "";

    // Render cards
    keys.forEach((k, index) => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img class="img" src="${k.imageUrl}" alt="Cover" />
        <div class="content">
          <div class="title">${escapeHtml(k.title)}</div>

          <button class="revealBtn btn-primary" type="button">Key anzeigen</button>

          <div class="keybox"></div>

          <div style="display:none; gap:8px;" class="afterReveal">
            <button class="copyBtn" type="button">Key kopieren</button>
            <button class="closeBtn" type="button">Schlie√üen</button>
          </div>

          <div class="small status"></div>
        </div>
      `;

      const btn = card.querySelector(".revealBtn");
      const keybox = card.querySelector(".keybox");
      const status = card.querySelector(".status");
      const afterReveal = card.querySelector(".afterReveal");
      const copyBtn = card.querySelector(".copyBtn");
      const closeBtn = card.querySelector(".closeBtn");

      btn.addEventListener("click", async () => {
      const ok = confirm("Willst du diesen Steam Key wirklich claimen?\n\n‚ö†Ô∏è Der Key kann nur einmal genutzt werden.");
      if (!ok) {
      return;
         }
        btn.disabled = true;
        status.textContent = "Claim l√§uft‚Ä¶";

        const claimRes = await fetch(`/api/claim/${k.id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ website: "" }) // Honeypot: muss IMMER leer sein
         });


        if (claimRes.status === 429) {
          toast("Bitte kurz warten ‚è≥", "error");
          btn.disabled = false;
          status.textContent = "";
          return;
        }

        if (claimRes.status === 409) {
          toast("Schon geclaimt (jemand war schneller) ‚ùå", "error");
          status.textContent = "Schon geclaimt.";
          btn.remove();
          return;
        }

        if (!claimRes.ok) {
          toast("Fehler beim Claim ‚ùå", "error");
          status.textContent = "Fehler beim Claim.";
          btn.disabled = false;
          return;
        }

        const data = await claimRes.json();

        // Show key + buttons
        keybox.style.display = "block";
        keybox.textContent = data.steamKey;
        afterReveal.style.display = "flex";

        // Feature 3: Erfolgsmoment (Glow + Toast)
        toast("Erfolgreich geclaimt ‚úÖ");
        card.style.boxShadow = "0 0 34px rgba(34,197,94,.35), var(--shadow)";

        // Feature 4: Letzter Key Hinweis
        // Wenn der User einen Key claimt und es war vorher der letzte verf√ºgbare
        if (keys.length === 1) {
          status.textContent = "üéâ Du hast den letzten Key erwischt!";
          toast("Du hast den letzten Key erwischt! üéâ");
        } else {
          status.textContent = "Geclaimt ‚Äì jetzt kopieren oder schlie√üen.";
        }

        // Kopieren
        copyBtn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(data.steamKey);
            toast("Key kopiert ‚úÖ");
            copyBtn.classList.add("btn-success");
            setTimeout(() => copyBtn.classList.remove("btn-success"), 700);
          } catch {
            const range = document.createRange();
            range.selectNodeContents(keybox);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
            toast("Markiert ‚Äì bitte Strg+C dr√ºcken", "error");
          }
        };

        // Schlie√üen
        closeBtn.onclick = () => smoothRemove(card);

        // Nach Claim: public Liste neu laden (damit Karte wirklich verschwindet und stats stimmen)
        // Kleine Verz√∂gerung, damit User erst kopieren kann. Wenn du willst, kann das auch sofort passieren.
      });

      grid.appendChild(card);
    });

    // Skeletons aus
    skeletons.style.display = "none";

    // Empty state
    if (keys.length === 0) {
      emptyState.classList.remove("hidden");
      grid.style.display = "none";
    } else {
      emptyState.classList.add("hidden");
      grid.style.display = "grid";
    }
  }

  // Feature 9: Teilen-Button (URL kopieren)
  document.getElementById("shareBtn").addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(location.href);
      toast("Link kopiert üîó");
    }catch{
      toast("Konnte Link nicht kopieren", "error");
    }
  });

  // Steam Cover holen
  document.getElementById("fetchCoverBtn").addEventListener("click", async () => {
    const title = document.getElementById("title").value.trim();
    const status = document.getElementById("coverStatus");

    if (!title) {
      status.textContent = "Bitte erst einen Spielnamen eingeben.";
      toast("Bitte erst Spielname eingeben", "error");
      return;
    }

    status.textContent = "Suche Steam‚Ä¶";

    const res = await fetch(`/api/steam/cover?title=${encodeURIComponent(title)}`);

    if (!res.ok) {
      status.textContent = "Kein Treffer gefunden (oder Steam nicht erreichbar).";
      toast("Kein Steam Treffer ‚ùå", "error");
      return;
    }

    const data = await res.json();
    document.getElementById("imageUrl").value = data.header;
    status.textContent = `Gefunden: ${data.matchedTitle} (AppID: ${data.appid})`;
    toast("Cover √ºbernommen ‚úÖ");
  });

  // Admin Table Sort state
  const adminState = {
    rows: [],
    sortKey: "id",
    sortDir: "asc"
  };

  function compareByKey(a, b, key, dir) {
    const mul = dir === "asc" ? 1 : -1;
    const av = a[key];
    const bv = b[key];

    if (key === "id" || key === "claimed") return (Number(av) - Number(bv)) * mul;

    if (key === "claimedAt") {
      const ad = av ? Date.parse(av) : 0;
      const bd = bv ? Date.parse(bv) : 0;
      return (ad - bd) * mul;
    }

    return String(av ?? "").localeCompare(String(bv ?? ""), "de", { sensitivity: "base" }) * mul;
  }

  function updateSortHeaderIndicators() {
    const ths = document.querySelectorAll("#adminTable thead th");
    ths.forEach(th => th.textContent = th.textContent.replace(/ [‚ñ≤‚ñº]$/, ""));

    const mapKeyToIndex = { id:0, title:1, claimed:2, claimedAt:3, steamKey:4 };
    const idx = mapKeyToIndex[adminState.sortKey];
    const arrow = adminState.sortDir === "asc" ? "‚ñ≤" : "‚ñº";
    if (ths[idx]) ths[idx].textContent = ths[idx].textContent + " " + arrow;
  }

  function attachAdminSortHandlers() {
    const ths = document.querySelectorAll("#adminTable thead th");
    const map = { 0:"id", 1:"title", 2:"claimed", 3:"claimedAt", 4:"steamKey" };

    ths.forEach((th, idx) => {
      if (!(idx in map)) return;
      th.style.cursor = "pointer";
      th.title = "Klicken zum Sortieren";

      th.addEventListener("click", () => {
        const key = map[idx];
        if (adminState.sortKey === key) adminState.sortDir = adminState.sortDir === "asc" ? "desc" : "asc";
        else { adminState.sortKey = key; adminState.sortDir = "asc"; }
        renderAdminTable();
      });
    });

    updateSortHeaderIndicators();
  }

  function renderAdminTable() {
    const tbody = document.querySelector("#adminTable tbody");
    const adminToken = document.getElementById("adminToken").value.trim();

    const rows = [...adminState.rows].sort((a,b) => compareByKey(a,b,adminState.sortKey, adminState.sortDir));

    tbody.innerHTML = "";
    rows.forEach(r => {
      const tr = document.createElement("tr");
      const claimedText = r.claimed ? "‚úÖ ja" : "‚ùå nein";
      const claimedAt = r.claimedAt ? r.claimedAt : "-";

      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${escapeHtml(r.title)}</td>
        <td>${claimedText}</td>
        <td>${escapeHtml(claimedAt)}</td>
        <td style="font-family: ui-monospace, Consolas, monospace;">${escapeHtml(r.steamKey)}</td>
        <td><button data-del-id="${r.id}" class="btn-danger" type="button">L√∂schen</button></td>
      `;

      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-del-id]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-del-id");
        if (!confirm(`Key mit ID ${id} wirklich l√∂schen?`)) return;

        const delRes = await fetch(`/api/admin/keys/${id}`, {
          method: "DELETE",
          headers: { "x-admin-token": adminToken }
        });

        if (!delRes.ok) {
          toast("L√∂schen fehlgeschlagen ‚ùå", "error");
          return;
        }

        toast("Gel√∂scht ‚úÖ");
        await loadAdminKeys();
        await loadKeys();
      });
    });

    updateSortHeaderIndicators();

    // Feature 6: claimed count anzeigen (nur wenn admin unlocked)
    const claimedCount = adminState.rows.filter(r => r.claimed).length;
    setClaimedCount(claimedCount);
  }

  async function loadAdminKeys() {
    const adminToken = document.getElementById("adminToken").value.trim();
    const status = document.getElementById("adminStatus");

    status.textContent = "Lade √úbersicht‚Ä¶";

    const res = await fetch("/api/admin/keys", {
      headers: { "x-admin-token": adminToken }
    });

    if (!res.ok) {
      status.textContent = "Fehler (Token falsch?)";
      toast("Admin Token falsch ‚ùå", "error");
      adminState.rows = [];
      renderAdminTable();
      return;
    }

    const rows = await res.json();
    adminState.rows = rows;
    status.textContent = `Gefunden: ${rows.length} Eintr√§ge`;
    renderAdminTable();
  }

  // Admin: hinzuf√ºgen + Bulk Import
  document.getElementById("addBtn").addEventListener("click", async () => {
    const title = document.getElementById("title").value.trim();
    const imageUrl = document.getElementById("imageUrl").value.trim();
    const steamKey = document.getElementById("steamKey").value.trim();
    const bulk = document.getElementById("bulkKeys").value.trim();
    const adminToken = document.getElementById("adminToken").value.trim();
    const addStatus = document.getElementById("addStatus");

    if (!title) { toast("Bitte Spielname eingeben", "error"); return; }
    if (!imageUrl) { toast("Bitte Cover holen oder Bild-URL setzen", "error"); return; }

    addStatus.textContent = "Speichere‚Ä¶";

    if (bulk) {
      const keys = bulk.split("\n").map(k => k.trim()).filter(Boolean);
      let okCount = 0;
      let dupCount = 0;

      for (const k of keys) {
        const r = await fetch("/api/admin/add", {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "x-admin-token": adminToken
          },
          body: JSON.stringify({ title, imageUrl, steamKey: k })
        });

        if (r.ok) okCount++;
        else if (r.status === 409) dupCount++;
      }

      toast(`${okCount} hinzugef√ºgt ‚úÖ${dupCount ? `, ${dupCount} doppelt ‚ùå` : ""}`);
      addStatus.textContent = "Bulk Import fertig.";
      document.getElementById("bulkKeys").value = "";
      document.getElementById("steamKey").value = "";

      await loadKeys();
      await loadAdminKeys();
      return;
    }

    if (!steamKey) { toast("Bitte Steam Key eingeben oder Bulk nutzen", "error"); return; }

    const res = await fetch("/api/admin/add", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-admin-token": adminToken
      },
      body: JSON.stringify({ title, imageUrl, steamKey })
    });

    if (res.status === 409) {
      toast("Steam-Key existiert bereits ‚ùå", "error");
      addStatus.textContent = "Doppelt.";
      return;
    }

    if (!res.ok) {
      toast("Fehler beim Hinzuf√ºgen ‚ùå", "error");
      addStatus.textContent = "Fehler.";
      return;
    }

    toast("Hinzugef√ºgt ‚úÖ");
    addStatus.textContent = "Hinzugef√ºgt!";
    document.getElementById("steamKey").value = "";

    await loadKeys();
    await loadAdminKeys();
  });

  document.getElementById("refreshAdminBtn").addEventListener("click", async () => {
    await loadAdminKeys();
  });

  // Admin unlock + token merken + logout
  async function unlockAdmin() {
    const token = document.getElementById("adminToken").value.trim();
    const status = document.getElementById("unlockStatus");
    const adminArea = document.getElementById("adminArea");
    const logoutBtn = document.getElementById("logoutBtn");

    if (!token) {
      status.textContent = "Bitte Token eingeben.";
      adminArea.classList.add("hidden");
      logoutBtn.classList.add("hidden");
      return;
    }

    status.textContent = "Pr√ºfe Token‚Ä¶";

    const res = await fetch("/api/admin/keys", {
      headers: { "x-admin-token": token }
    });

    if (!res.ok) {
      status.textContent = "Token falsch.";
      adminArea.classList.add("hidden");
      logoutBtn.classList.add("hidden");
      return;
    }

    status.textContent = "Admin freigeschaltet ‚úÖ";
    adminArea.classList.remove("hidden");
    logoutBtn.classList.remove("hidden");

    // Token merken
    localStorage.setItem("adminToken", token);

    // Admin Tabelle laden
    await loadAdminKeys();
  }

  document.getElementById("unlockAdminBtn").addEventListener("click", unlockAdmin);

  document.getElementById("adminToken").addEventListener("keydown", (e) => {
    if (e.key === "Enter") unlockAdmin();
  });

  document.getElementById("logoutBtn").addEventListener("click", async () => {
    localStorage.removeItem("adminToken");
    document.getElementById("adminToken").value = "";
    document.getElementById("adminArea").classList.add("hidden");
    document.getElementById("logoutBtn").classList.add("hidden");
    document.getElementById("unlockStatus").textContent = "Ausgeloggt.";
    document.getElementById("statsClaimed").classList.add("hidden");
    toast("Logout ‚úÖ");
  });

  // Auto-login
  const saved = localStorage.getItem("adminToken");
  if (saved) {
    document.getElementById("adminToken").value = saved;
    // nicht sofort toasten, einfach entsperren
    unlockAdmin();
  }

  // Init
  attachAdminSortHandlers();
  loadKeys();
</script>
</body>
</html>
